# Frontend Billing System Guide

## Tổng quan

Hệ thống billing mới được thiết kế để tự động tạo hóa đơn dựa trên các loại chi phí của phòng và xử lý các trường hợp đặc biệt như rental tạo sau ngày tính.

## API Endpoints

### 1. Tạo hóa đơn tự động
```http
POST /bills/generate
```

**Request Body:**
```typescript
{
  rentalId: string;                    // ID của rental
  roomInstanceId: string;              // ID của room instance
  billingPeriod: string;               // Kỳ hóa đơn (format: "YYYY-MM")
  billingMonth: number;                // Tháng (1-12)
  billingYear: number;                 // Năm
  periodStart: string;                 // Ngày bắt đầu kỳ (ISO date)
  periodEnd: string;                   // Ngày kết thúc kỳ (ISO date)
  occupancyCount?: number;             // Số người ở (cho per_person costs)
  rentalStartDate?: string;            // Ngày bắt đầu rental trong kỳ (cho prorated)
  rentalEndDate?: string;              // Ngày kết thúc rental trong kỳ (cho prorated)
  notes?: string;                      // Ghi chú
}
```

**Response:**
```typescript
{
  id: string;
  rentalId: string;
  roomInstanceId: string;
  billingPeriod: string;
  billingMonth: number;
  billingYear: number;
  periodStart: Date;
  periodEnd: Date;
  rentalStartDate?: Date;              // Ngày bắt đầu rental trong kỳ
  rentalEndDate?: Date;                // Ngày kết thúc rental trong kỳ
  occupancyCount?: number;             // Số người ở
  subtotal: number;
  discountAmount: number;
  taxAmount: number;
  totalAmount: number;
  paidAmount: number;
  remainingAmount: number;
  status: "draft" | "pending" | "paid" | "overdue" | "cancelled";
  dueDate: Date;
  paidDate?: Date;
  notes?: string;
  isAutoGenerated: boolean;            // true nếu được tạo tự động
  requiresMeterData: boolean;          // true nếu cần nhập dữ liệu đồng hồ
  billItems: BillItem[];
  rental: {
    id: string;
    monthlyRent: number;
    roomInstance: {
      roomNumber: string;
      room: {
        name: string;
      };
    };
  };
}
```

### 2. Cập nhật dữ liệu đồng hồ
```http
POST /bills/:id/meter-data
```

**Request Body:**
```typescript
[
  {
    roomCostId: string;                // ID của room cost (metered type)
    currentReading: number;            // Số đồng hồ hiện tại
    lastReading: number;               // Số đồng hồ tháng trước
  }
]
```

### 3. Lấy danh sách hóa đơn
```http
GET /bills?page=1&limit=20&rentalId=xxx&status=pending&billingPeriod=2025-01
```

**Query Parameters:**
- `page`: Số trang (default: 1)
- `limit`: Số lượng mỗi trang (default: 20)
- `rentalId`: Lọc theo rental ID
- `roomInstanceId`: Lọc theo room instance ID
- `status`: Lọc theo trạng thái
- `fromDate`: Từ ngày (ISO date)
- `toDate`: Đến ngày (ISO date)
- `billingPeriod`: Kỳ hóa đơn (format: "YYYY-MM")

### 4. Lấy chi tiết hóa đơn
```http
GET /bills/:id
```

### 5. Cập nhật hóa đơn
```http
PATCH /bills/:id
```

**Request Body:**
```typescript
{
  status?: "draft" | "pending" | "paid" | "overdue" | "cancelled";
  discountAmount?: number;
  taxAmount?: number;
  totalAmount?: number;
  dueDate?: string;                    // ISO date
  notes?: string;
}
```

### 6. Đánh dấu đã thanh toán
```http
POST /bills/:id/mark-paid
```

### 7. Xóa hóa đơn
```http
DELETE /bills/:id
```

## Các loại chi phí (Cost Types)

### 1. Fixed (Cố định)
- **Mô tả**: Giá cố định hàng tháng
- **Tính toán**: `fixedAmount * prorationFactor`
- **Prorated**: Có (theo % thời gian rental trong kỳ)
- **Cần nhập**: Không

### 2. Per Person (Theo người)
- **Mô tả**: Chia đều cho số người ở
- **Tính toán**: `perPersonAmount * occupancyCount * prorationFactor`
- **Prorated**: Có (theo % thời gian rental trong kỳ)
- **Cần nhập**: `occupancyCount` (số người ở)

### 3. Metered (Thang đo)
- **Mô tả**: Theo đồng hồ (điện, nước)
- **Tính toán**: `(currentReading - lastReading) * unitPrice`
- **Prorated**: Không (tính theo usage thực tế)
- **Cần nhập**: `currentReading`, `lastReading`

## Prorated Calculation

### Khi nào áp dụng prorated?
- Rental tạo sau ngày bắt đầu kỳ hóa đơn
- Rental kết thúc trước ngày kết thúc kỳ hóa đơn

### Công thức tính:
```
prorationFactor = rentalDaysInPeriod / totalDaysInPeriod
```

### Ví dụ:
- Kỳ hóa đơn: 1/1/2025 - 31/1/2025 (31 ngày)
- Rental: 15/1/2025 - 31/1/2025 (17 ngày)
- Proration factor: 17/31 = 54.8%
- Tiền phòng: 5,000,000 VND * 54.8% = 2,741,935 VND

## Bill Items Structure

```typescript
interface BillItem {
  id: string;
  itemType: "rent" | "utility" | "service" | "other";
  itemName: string;                    // Tên item (có thể chứa thông tin prorated)
  description?: string;                // Mô tả (có thể chứa % prorated)
  quantity?: number;                   // Số lượng (cho per_person, metered)
  unitPrice?: number;                  // Đơn giá
  amount: number;                      // Thành tiền
  currency: string;                    // Tiền tệ
  notes?: string;                      // Ghi chú
  createdAt: Date;
}
```

## Trạng thái hóa đơn (Bill Status)

- `draft`: Nháp
- `pending`: Chờ thanh toán
- `paid`: Đã thanh toán
- `overdue`: Quá hạn
- `cancelled`: Đã hủy

## Flags đặc biệt

### `isAutoGenerated`
- `true`: Hóa đơn được tạo tự động bởi hệ thống
- `false`: Hóa đơn được tạo thủ công

### `requiresMeterData`
- `true`: Cần nhập dữ liệu đồng hồ cho metered costs
- `false`: Không cần nhập dữ liệu bổ sung

## Workflow đề xuất cho Frontend

### 1. Tạo hóa đơn tự động
```typescript
// 1. Gọi API generate bill
const response = await generateBill({
  rentalId: "rental-id",
  roomInstanceId: "room-instance-id",
  billingPeriod: "2025-01",
  billingMonth: 1,
  billingYear: 2025,
  periodStart: "2025-01-01",
  periodEnd: "2025-01-31",
  occupancyCount: 2, // Nếu có per_person costs
  rentalStartDate: "2025-01-15", // Nếu rental tạo sau ngày tính
  rentalEndDate: "2025-01-31",   // Nếu rental kết thúc trước ngày tính
});

// 2. Kiểm tra requiresMeterData
if (response.requiresMeterData) {
  // Hiển thị form nhập dữ liệu đồng hồ
  showMeterDataForm(response.billItems.filter(item => item.itemType === 'utility'));
}
```

### 2. Nhập dữ liệu đồng hồ
```typescript
// Lấy danh sách metered costs cần nhập
const meteredCosts = await getMeteredCosts(roomId);

// Hiển thị form nhập
const meterData = [
  {
    roomCostId: "cost-id-1",
    currentReading: 1500.5,
    lastReading: 1200.0,
  }
];

// Cập nhật dữ liệu đồng hồ
await updateMeterData(billId, meterData);
```

### 3. Hiển thị hóa đơn
```typescript
// Hiển thị thông tin prorated
if (bill.isAutoGenerated && bill.rentalStartDate) {
  const prorationPercent = calculateProrationPercent(
    bill.rentalStartDate,
    bill.rentalEndDate,
    bill.periodStart,
    bill.periodEnd
  );
  
  // Hiển thị "Hóa đơn được tính theo 54.8% thời gian thuê"
  showProrationNotice(prorationPercent);
}

// Hiển thị bill items với thông tin chi tiết
bill.billItems.forEach(item => {
  if (item.description?.includes('% tháng')) {
    // Hiển thị item với badge "Prorated"
    showProratedItem(item);
  } else if (item.quantity && item.quantity > 1) {
    // Hiển thị item với số lượng (per_person, metered)
    showQuantityItem(item);
  }
});
```

## Lưu ý quan trọng

1. **Prorated Calculation**: Luôn kiểm tra `rentalStartDate` và `rentalEndDate` để hiển thị thông tin prorated
2. **Meter Data**: Kiểm tra `requiresMeterData` trước khi cho phép thanh toán
3. **Occupancy Count**: Cần nhập chính xác số người ở cho per_person costs
4. **Auto-generation**: Hóa đơn tự động sẽ có `isAutoGenerated = true`
5. **Validation**: Frontend nên validate dữ liệu trước khi gửi API

## Error Handling

### Lỗi thường gặp:
- `Bill already exists for this period`: Hóa đơn đã tồn tại cho kỳ này
- `Room instance does not belong to this rental`: Room instance không thuộc rental
- `Not authorized to create bill for this rental`: Không có quyền tạo hóa đơn
- `Cannot update paid bills`: Không thể cập nhật hóa đơn đã thanh toán

### Xử lý lỗi:
```typescript
try {
  const bill = await generateBill(data);
} catch (error) {
  if (error.message.includes('already exists')) {
    showError('Hóa đơn cho kỳ này đã tồn tại');
  } else if (error.message.includes('Not authorized')) {
    showError('Bạn không có quyền tạo hóa đơn cho rental này');
  } else {
    showError('Có lỗi xảy ra khi tạo hóa đơn');
  }
}
```
