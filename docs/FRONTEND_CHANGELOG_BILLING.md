# Frontend Changelog - Billing System Update

## Version 2.0.0 - Billing System Redesign

### üöÄ Major Changes

#### 1. Cost Types Simplified
**BREAKING CHANGE**: Cost types reduced from 5 to 3

**Removed:**
- `per_unit` ‚Üí Use `per_person` instead
- `percentage` ‚Üí Not supported
- `tiered` ‚Üí Not supported

**New/Updated:**
- `fixed` - Gi√° c·ªë ƒë·ªãnh h√†ng th√°ng (unchanged)
- `per_person` - Chia ƒë·ªÅu cho s·ªë ng∆∞·ªùi ·ªü (renamed from `per_unit`)
- `metered` - Theo ƒë·ªìng h·ªì (unchanged)

#### 2. Auto-Generation System
**NEW FEATURE**: Bills can now be auto-generated

**Before:**
```typescript
// Manual bill creation
const bill = await createBill({
  rentalId: "rental-123",
  // ... manual calculation
});
```

**Now:**
```typescript
// Auto-generation
const bill = await generateBill({
  rentalId: "rental-123",
  roomInstanceId: "room-instance-456",
  billingPeriod: "2025-01",
  // ... system calculates automatically
});
```

#### 3. Prorated Calculation
**NEW FEATURE**: Automatic prorated calculation for partial periods

**When it applies:**
- Rental starts after billing period start
- Rental ends before billing period end

**Example:**
- Billing period: Jan 1-31 (31 days)
- Rental period: Jan 15-31 (17 days)
- Proration: 17/31 = 54.8%
- Rent: 5,000,000 VND √ó 54.8% = 2,741,935 VND

### üìã New API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/bills/generate` | POST | Auto-generate bill |
| `/bills/:id/meter-data` | POST | Update meter readings |

### üîß New Fields

#### Bill Model
```typescript
interface Bill {
  // ... existing fields
  rentalStartDate?: Date;     // NEW: Rental start in period
  rentalEndDate?: Date;       // NEW: Rental end in period
  occupancyCount?: number;    // NEW: Number of occupants
  isAutoGenerated: boolean;   // NEW: Auto-generated flag
  requiresMeterData: boolean; // NEW: Needs meter data
}
```

#### RoomCost Model
```typescript
interface RoomCost {
  // ... existing fields
  perPersonAmount?: number;   // NEW: Price per person
  unitPrice?: number;         // UPDATED: Price per unit (metered)
  unit?: string;              // NEW: Unit of measurement
  meterReading?: number;      // NEW: Current meter reading
  lastMeterReading?: number;  // NEW: Previous meter reading
}
```

### üé® UI Changes Required

#### 1. Cost Type Selection
**Before:**
```typescript
const costTypes = [
  { value: 'fixed', label: 'Fixed' },
  { value: 'per_unit', label: 'Per Unit' },
  { value: 'metered', label: 'Metered' },
  { value: 'percentage', label: 'Percentage' },
  { value: 'tiered', label: 'Tiered' }
];
```

**Now:**
```typescript
const costTypes = [
  { value: 'fixed', label: 'Fixed' },
  { value: 'per_person', label: 'Per Person' },
  { value: 'metered', label: 'Metered' }
];
```

#### 2. Bill Creation Flow
**New Flow:**
1. Select rental and room instance
2. Choose billing period
3. Enter occupancy count (if per_person costs exist)
4. Enter rental dates (if different from billing period)
5. System auto-generates bill
6. If `requiresMeterData = true`, show meter data form
7. Submit meter data to complete bill

#### 3. Bill Display
**New Elements:**
- Proration indicator: "Bill calculated for 54.8% of period"
- Auto-generation badge: "Auto-generated"
- Meter data required warning: "Meter readings needed"
- Occupancy info: "For 2 occupants"

#### 4. Meter Data Form
**New Component:**
```typescript
interface MeterDataForm {
  roomCostId: string;
  costName: string;
  unit: string;
  currentReading: number;
  lastReading: number;
}
```

### üîÑ Migration Steps

#### 1. Update Cost Type Handling
```typescript
// Remove old cost types
const OLD_COST_TYPES = ['per_unit', 'percentage', 'tiered'];

// Update validation
if (OLD_COST_TYPES.includes(costType)) {
  throw new Error('Cost type not supported in v2.0');
}
```

#### 2. Update Bill Creation
```typescript
// Replace manual bill creation with auto-generation
const createBill = async (data) => {
  if (data.autoGenerate) {
    return await generateBill(data);
  } else {
    return await createBillManual(data);
  }
};
```

#### 3. Add Proration Display
```typescript
const ProrationIndicator = ({ bill }) => {
  if (bill.isAutoGenerated && bill.rentalStartDate) {
    const percent = calculateProrationPercent(bill);
    return (
      <div className="proration-indicator">
        Calculated for {percent}% of billing period
      </div>
    );
  }
  return null;
};
```

#### 4. Add Meter Data Form
```typescript
const MeterDataForm = ({ bill, onSubmit }) => {
  if (!bill.requiresMeterData) return null;
  
  return (
    <form onSubmit={onSubmit}>
      {bill.meteredCosts.map(cost => (
        <div key={cost.id}>
          <label>{cost.name} ({cost.unit})</label>
          <input 
            type="number" 
            name={`${cost.id}.currentReading`}
            placeholder="Current reading"
          />
          <input 
            type="number" 
            name={`${cost.id}.lastReading`}
            placeholder="Last reading"
          />
        </div>
      ))}
    </form>
  );
};
```

### ‚ö†Ô∏è Breaking Changes

1. **Cost Types**: Remove support for `per_unit`, `percentage`, `tiered`
2. **API Endpoints**: Old bill creation endpoint deprecated
3. **Validation**: Update cost type validation
4. **UI Components**: Update cost type selectors

### üêõ Bug Fixes

1. **Prorated Calculation**: Fixed calculation for partial periods
2. **Meter Data**: Proper handling of meter readings
3. **Auto-generation**: Consistent bill generation logic

### üìö Documentation

- [Full Billing Guide](./FRONTEND_BILLING_GUIDE.md)
- [API Reference](./BILLING_API_REFERENCE.md)
- [Migration Guide](./MIGRATION_GUIDE.md)

### üß™ Testing

#### Test Cases
1. **Auto-generation**: Test with different cost types
2. **Proration**: Test with various rental periods
3. **Meter Data**: Test meter reading updates
4. **Occupancy**: Test per_person calculations

#### Sample Data
```typescript
const testRental = {
  id: "rental-123",
  contractStartDate: "2025-01-15",
  contractEndDate: "2025-12-31",
  monthlyRent: 5000000
};

const testRoomCosts = [
  {
    id: "cost-1",
    costType: "fixed",
    fixedAmount: 500000,
    costTypeTemplate: { name: "Internet" }
  },
  {
    id: "cost-2", 
    costType: "per_person",
    perPersonAmount: 200000,
    costTypeTemplate: { name: "Cleaning" }
  },
  {
    id: "cost-3",
    costType: "metered", 
    unitPrice: 3000,
    unit: "kWh",
    costTypeTemplate: { name: "Electricity" }
  }
];
```

### üöÄ Deployment

1. **Backend**: Deploy new billing system
2. **Database**: Run migration for new fields
3. **Frontend**: Deploy updated UI components
4. **Testing**: Verify all functionality works
5. **Rollback**: Keep old system as fallback

### üìû Support

For questions or issues:
- Technical: Contact backend team
- UI/UX: Contact frontend team  
- Testing: Contact QA team
