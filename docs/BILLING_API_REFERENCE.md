# Billing API Reference

## Quick Reference

### Endpoints
| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/bills/generate` | Tạo hóa đơn tự động | Landlord |
| POST | `/bills` | Tạo hóa đơn thủ công | Landlord |
| GET | `/bills` | Lấy danh sách hóa đơn | Both |
| GET | `/bills/:id` | Lấy chi tiết hóa đơn | Both |
| PATCH | `/bills/:id` | Cập nhật hóa đơn | Landlord |
| DELETE | `/bills/:id` | Xóa hóa đơn | Landlord |
| POST | `/bills/:id/mark-paid` | Đánh dấu đã thanh toán | Landlord |
| POST | `/bills/:id/meter-data` | Cập nhật dữ liệu đồng hồ | Landlord |

### Cost Types
| Type | Description | Prorated | Input Required |
|------|-------------|----------|----------------|
| `fixed` | Giá cố định hàng tháng | ✅ | ❌ |
| `per_person` | Chia đều cho số người ở | ✅ | `occupancyCount` |
| `metered` | Theo đồng hồ (điện, nước) | ❌ | `currentReading`, `lastReading` |

### Bill Status
- `draft` - Nháp
- `pending` - Chờ thanh toán  
- `paid` - Đã thanh toán
- `overdue` - Quá hạn
- `cancelled` - Đã hủy

### Special Flags
- `isAutoGenerated` - Hóa đơn được tạo tự động
- `requiresMeterData` - Cần nhập dữ liệu đồng hồ

## Key Changes from Old System

### 1. Cost Types Simplified
**Before:** 5 types (`fixed`, `per_unit`, `metered`, `percentage`, `tiered`)
**Now:** 3 types (`fixed`, `per_person`, `metered`)

### 2. Auto-Generation
- Hệ thống tự động tính toán dựa trên room costs
- Prorated calculation cho rental tạo sau ngày tính
- Chỉ cần nhập dữ liệu đồng hồ cho metered costs

### 3. Prorated Calculation
- Tự động tính % thời gian rental trong kỳ hóa đơn
- Áp dụng cho `fixed` và `per_person` costs
- Không áp dụng cho `metered` costs (tính theo usage thực tế)

### 4. New Fields
```typescript
// Bill model
rentalStartDate?: Date;     // Ngày bắt đầu rental trong kỳ
rentalEndDate?: Date;       // Ngày kết thúc rental trong kỳ  
occupancyCount?: number;    // Số người ở trong kỳ
isAutoGenerated: boolean;   // Tự động tạo
requiresMeterData: boolean; // Cần nhập dữ liệu đồng hồ

// RoomCost model  
perPersonAmount?: number;   // Giá per person
unitPrice?: number;         // Giá per unit (metered)
unit?: string;              // Đơn vị đo
meterReading?: number;      // Số đồng hồ hiện tại
lastMeterReading?: number;  // Số đồng hồ tháng trước
```

## Migration Notes

### Frontend Changes Required
1. **Update Cost Type handling**: Remove `per_unit`, `percentage`, `tiered`
2. **Add Prorated UI**: Show proration percentage for bills
3. **Add Meter Data Form**: For metered costs
4. **Update Bill Creation**: Use auto-generation instead of manual
5. **Add Occupancy Input**: For per_person costs

### Backward Compatibility
- Old bills will continue to work
- New cost types are additive (old data preserved)
- API responses maintain same structure

## Example Usage

### Generate Bill with Prorated Calculation
```typescript
const bill = await generateBill({
  rentalId: "rental-123",
  roomInstanceId: "room-instance-456", 
  billingPeriod: "2025-01",
  billingMonth: 1,
  billingYear: 2025,
  periodStart: "2025-01-01",
  periodEnd: "2025-01-31",
  occupancyCount: 2,
  rentalStartDate: "2025-01-15", // Rental starts mid-month
  rentalEndDate: "2025-01-31"
});

// Result: Bill with 54.8% proration for fixed/per_person costs
```

### Update Meter Data
```typescript
await updateMeterData("bill-123", [
  {
    roomCostId: "cost-electricity-789",
    currentReading: 1500.5,
    lastReading: 1200.0
  }
]);

// Result: Bill recalculated with new meter readings
```
